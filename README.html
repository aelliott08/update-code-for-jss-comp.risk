<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Update code for comp.risk and JSS</title>
<!-- 2020-04-09 Thu 15:56 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="orgmode5-ts.css">
<link rel="icon" type="image/x-icon" href="http://www.biostat.ku.dk/~kkho/styles/logo.ico"/>
<style type="text/css">body { background-image: url(http://www.biostat.ku.dk/~kkho/styles/sund.png); background-size:120px 95px; background-position: 2% 0.55em; }
a.logo span { background: none; }
th,td,tr,table th,table th,table td {
background: rgba(240,240,240,1);
border: none;
}
body { width: 800px; text-align:justify; text-justify:inter-word; }
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="preamble" class="status">

<script type="text/javascript">
  function swapStyleSheet(sheet){
      document.getElementById('pagestyle').setAttribute('href', sheet);
  }
  document.addEventListener('DOMContentLoaded',function() {
      document.getElementById('content').onclick = function() {
          var elem = document.getElementById('text-table-of-contents');
          elem.style.display = elem.style.display == 'block' ? 'none' : 'block';
      }
  });
  document.addEventListener('DOMContentLoaded',function() {
      document.getElementById('content').onclick = function() {
          var elem = document.getElementsByClassName('nav');
          for (i = 0; i < elem.length; i++) { 
               elem[i].style.display = elem[i].style.display == 'block' ? 'none' : 'block';
          }
      }
  });
</script>
</div>
<div id="content">
<h1 class="title">Update code for comp.risk and JSS</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">update of code for JSS paper on comp.risk in  Timereg</a>
<ul>
<li><a href="#sec-1-1">R-code in file</a></li>
</ul>
</li>
</ul>
</div>
</div>
<a href="http://www.biostat.ku.dk/~ts/survival class="logo"><span></span></a>


<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">update of code for JSS paper on comp.risk in  Timereg</h2>
<div class="outline-text-2" id="text-1">
<p>
Due to various developments the original code not longer runs, also
due to some changes in the numerical procedures. This version of the
file is slightly changed and runs !
</p>



<blockquote>
"Thomas H. Scheike, Mei-Jie Zhang (2011)."
"Analyzing Competing Risk Data Using the R timereg Package."
"Journal of Statistical Software, 38(2), 1-15."
"URL <a href="http://www.jstatsoft.org/v38/i02/">http://www.jstatsoft.org/v38/i02/</a>."
</blockquote>
</div>

<div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1">R-code in file</h3>
<div class="outline-text-3" id="text-1-1">
<div class="org-src-container">

<pre class="src src-R">fol <span style="font-weight: bold; text-decoration: underline;">&lt;-</span> read.table(<span style="font-style: italic;">"follic.txt"</span>,sep=<span style="font-style: italic;">","</span>,header=<span style="font-weight: bold; text-decoration: underline;">TRUE</span>)
evcens <span style="font-weight: bold; text-decoration: underline;">&lt;-</span> (fol$resp==<span style="font-style: italic;">"NR"</span> | fol$relsite!=<span style="font-style: italic;">""</span>)+0
crcens <span style="font-weight: bold; text-decoration: underline;">&lt;-</span> (fol$resp==<span style="font-style: italic;">"CR"</span> &amp; fol$relsite==<span style="font-style: italic;">""</span> &amp; fol$stat==1)+0
cause <span style="font-weight: bold; text-decoration: underline;">&lt;-</span> ifelse(evcens==1,1,ifelse(crcens==1,2,0))
table(cause)

stage <span style="font-weight: bold; text-decoration: underline;">&lt;-</span> as.numeric(fol$clinstg==2) 
fol$chemo<span style="font-weight: bold; text-decoration: underline;">&lt;-</span>as.numeric(fol$ch==<span style="font-style: italic;">"Y"</span>)
times1=sort(unique(fol$dftime[cause==1]))
fol$age <span style="font-weight: bold; text-decoration: underline;">&lt;-</span> scale(fol$age)

<span style="font-weight: bold; text-decoration: underline;">library</span>(<span style="font-style: italic;">"timereg"</span>)
<span style="font-weight: bold; text-decoration: underline;">library</span>(<span style="font-style: italic;">"cmprsk"</span>)

out1 <span style="font-weight: bold; text-decoration: underline;">&lt;-</span>comp.risk(Event(dftime,cause)~+1,data=fol,cause=1,model=<span style="font-style: italic;">"additive"</span>)
pout1 <span style="font-weight: bold; text-decoration: underline;">&lt;-</span> predict(out1,X=1)
group<span style="font-weight: bold; text-decoration: underline;">&lt;-</span>rep(1,541)
fit<span style="font-weight: bold; text-decoration: underline;">&lt;-</span>cuminc(fol$dftime,cause,group,cencode=0)

paper <span style="font-weight: bold; text-decoration: underline;">&lt;-</span> 0
<span style="font-weight: bold;">if</span> (paper==1) pdf(<span style="font-style: italic;">"fig1.pdf"</span>,height=8,width=13)
par(mfrow=c(1,2))
plot(fit,main=<span style="font-style: italic;">"cmprsk"</span>,xlab=<span style="font-style: italic;">"Years (a)"</span>)
plot(pout1,xlim=c(0,30),xlab=<span style="font-style: italic;">"Years (b)"</span>,main=<span style="font-style: italic;">"timereg"</span>,uniform=2,se=3)
<span style="font-weight: bold;">if</span> (paper==1) dev.off()
</pre>
</div>


<pre class="example">
[[file:fig1.png]]
</pre>


<div class="figure">
<p><img src="fig1.png" alt="fig1.png" />
</p>
</div>

<div class="org-src-container">

<pre class="src src-R"><span style="font-weight: bold; font-style: italic;">## </span><span style="font-weight: bold; font-style: italic;">problems with convergence when hgb included</span>
outf<span style="font-weight: bold; text-decoration: underline;">&lt;-</span>comp.risk(Event(dftime,cause)~stage+age+chemo,
data=fol,cause=1,n.sim=5000,model=<span style="font-style: italic;">"prop"</span>,cens.model=<span style="font-style: italic;">"cox"</span>)
summary(outf)
</pre>
</div>

<pre class="example">
Competing risks Model 

Test for nonparametric terms 

Test for non-significant effects 
            Supremum-test of significance p-value H_0: B(t)=0
(Intercept)                         12.10              0.0000
stage                                5.04              0.0002
age                                  4.07              0.0010
chemo                                2.18              0.1810

Test for time invariant effects 
                  Kolmogorov-Smirnov test p-value H_0:constant effect
(Intercept)                         2.980                      0.0000
stage                               0.950                      0.0190
age                                 0.853                      0.0020
chemo                               0.760                      0.0212
                    Cramer von Mises test p-value H_0:constant effect
(Intercept)                        13.200                      0.0000
stage                               2.660                      0.0004
age                                 0.457                      0.0030
chemo                               0.482                      0.3360
</pre>


<div class="org-src-container">

<pre class="src src-R">paper <span style="font-weight: bold; text-decoration: underline;">&lt;-</span> 0
<span style="font-weight: bold;">if</span> (paper==1) pdf(<span style="font-style: italic;">"fig2.pdf"</span>,height=8,width=13)
par(mfrow=c(2,2))
<span style="font-weight: bold;">for</span> (i <span style="font-weight: bold;">in</span> 2:4) plot(outf,specific.comps=i,pointwise.ci=2,sim.ci=3) 
<span style="font-weight: bold;">if</span> (paper==1) dev.off()
</pre>
</div>

<pre class="example">
[[file:fig2.png]]
</pre>


<div class="figure">
<p><img src="fig2.png" alt="fig2.png" />
</p>
</div>

<div class="org-src-container">

<pre class="src src-R"><span style="font-weight: bold;">if</span> (paper==1) pdf(<span style="font-style: italic;">"fig3.pdf"</span>,height=8,width=13)
par(mfrow=c(2,2)) 
<span style="font-weight: bold;">for</span> (i <span style="font-weight: bold;">in</span> 2:4) plot(outf,specific.comps=i,score=1) 
<span style="font-weight: bold;">if</span> (paper==1) dev.off()
</pre>
</div>

<pre class="example">
[[file:fig3.png]]
</pre>


<div class="figure">
<p><img src="fig3.png" alt="fig3.png" />
</p>
</div>

<div class="org-src-container">

<pre class="src src-R">outf1<span style="font-weight: bold; text-decoration: underline;">&lt;-</span>comp.risk(Event(dftime,cause)~stage+age+const(hgb)+chemo,
data=fol,cause=1,times=times1,model=<span style="font-style: italic;">"prop"</span>)
summary(outf1)
</pre>
</div>

<pre class="example">
Competing risks Model 

No test for non-parametric terms
Parametric terms : 
              Coef.      SE Robust SE      z P-val lower2.5% upper97.5%
const(hgb) 0.000387 0.00406   0.00406 0.0953 0.924  -0.00757    0.00834
</pre>

<div class="org-src-container">

<pre class="src src-R">outfg<span style="font-weight: bold; text-decoration: underline;">&lt;-</span>comp.risk(Event(dftime,cause)~const(stage)+const(age)+
const(hgb)+const(chemo),data=fol,cause=1,times=times1,model=<span style="font-style: italic;">"prop"</span>,cens.model=<span style="font-style: italic;">"cox"</span>)
summary(outfg)
</pre>
</div>

<pre class="example">
Competing risks Model 

No test for non-parametric terms
Parametric terms : 
                 Coef.      SE Robust SE       z    P-val lower2.5% upper97.5%
const(stage)  0.678000 0.13900   0.13900  4.8800 1.05e-06   0.40600    0.95000
const(age)    0.280000 0.07210   0.07210  3.8900 1.02e-04   0.13900    0.42100
const(hgb)    0.000149 0.00413   0.00413  0.0362 9.71e-01  -0.00795    0.00824
const(chemo) -0.302000 0.17600   0.17600 -1.7200 8.59e-02  -0.64700    0.04300
</pre>


<div class="org-src-container">

<pre class="src src-R"><span style="font-weight: bold; font-style: italic;">## </span><span style="font-weight: bold; font-style: italic;">predictions for fg model and outf1</span>
newdata=data.frame(stage=c(0,1),age=c(-1,0.3),hgb=rep(138,2),chemo=c(0,1))

poutf1<span style="font-weight: bold; text-decoration: underline;">&lt;-</span>predict(outf1,newdata)
poutfg<span style="font-weight: bold; text-decoration: underline;">&lt;-</span>predict(outfg,newdata)

<span style="font-weight: bold;">if</span> (paper==1) pdf(<span style="font-style: italic;">"fig4.pdf"</span>,height=8,width=13)
par(mfrow=c(1,2))
plot(poutf1,multiple=1,se=0,uniform=0,col=1:2,lty=1:2)
title(main=<span style="font-style: italic;">"Flexible model predictions"</span>)
plot(poutfg,multiple=1,se=0,uniform=0,col=1:2,lty=1:2)
title(main=<span style="font-style: italic;">"Fine-Gray model predictions"</span>)
<span style="font-weight: bold;">if</span> (paper==1) dev.off()
</pre>
</div>

<pre class="example">
[[file:fig4.png]]
</pre>


<div class="figure">
<p><img src="fig4.png" alt="fig4.png" />
</p>
</div>

<div class="org-src-container">

<pre class="src src-R">paper <span style="font-weight: bold; text-decoration: underline;">&lt;-</span> 0
<span style="font-weight: bold;">if</span> (paper==1) pdf(<span style="font-style: italic;">"fig5.pdf"</span>,height=8,width=13)
par(mfrow=c(1,2))
plot(poutf1,se=0,uniform=2,col=1,lty=1,specific.comps=1)
plot(poutfg,new=0,se=0,uniform=0,col=2,lty=2,specific.comps=1)
title(main=<span style="font-style: italic;">"Type I patients"</span>)
legend(1,1.0,c(<span style="font-style: italic;">"Flexible model"</span>,<span style="font-style: italic;">"Fine-Gray model"</span>),lty=1:2,col=1:2)
plot(poutf1,se=0,uniform=1,col=1,lty=1,specific.comps=2)
plot(poutfg,new=0,se=0,uniform=0,col=2,lty=2,specific.comps=2)
title(main=<span style="font-style: italic;">"Type II patients"</span>)
legend(1,1.0,c(<span style="font-style: italic;">"Flexible model"</span>,<span style="font-style: italic;">"Fine-Gray model"</span>),lty=1:2,col=1:2)
<span style="font-weight: bold;">if</span> (paper==1) dev.off()
</pre>
</div>

<pre class="example">
[[file:fig5.png]]
</pre>


<div class="figure">
<p><img src="fig5.png" alt="fig5.png" />
</p>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Created: 2020-04-09 Thu 15:56</p>
<p class="validation"></p>
</div>
</body>
</html>
